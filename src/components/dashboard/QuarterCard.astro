---
import Card from "../ui/Card.astro";
import Badge from "../ui/Badge.astro";
import { getSLAStatusColor } from "../../lib/sla-calculator";
import type { QuarterData } from "../../lib/sla-calculator";

interface Props {
    quarterData: QuarterData;
}

const { quarterData } = Astro.props;
const {
    quarterLabel,
    totalIncidents,
    hasViolation,
    hasInsufficientData,
    worstComponent,
    slaResults,
} = quarterData;

// Calculate service status summary
const passCount = slaResults.filter(r => r.uptimePercentage >= 99.9).length;
const violationCount = slaResults.filter(r => r.uptimePercentage < 99.9).length;
const violatedServices = slaResults
    .filter(r => r.uptimePercentage < 99.9)
    .map(r => r.componentName);

// Use worst component's uptime for status indication
const worstUptime = worstComponent.uptimePercentage;
const statusColor = getSLAStatusColor(worstUptime, hasInsufficientData);
const statusClass = `status-${statusColor}`;
---

<a href={`${import.meta.env.BASE_URL}/${quarterLabel}`} class="quarter-link">
    <Card class={`quarter-card ${statusClass}`}>
        <div class="quarter-header">
            <h3>{quarterLabel}</h3>
            {
                hasInsufficientData ? (
                    <Badge variant="secondary">Unknown</Badge>
                ) : hasViolation ? (
                    <Badge variant="danger">SLA Violation</Badge>
                ) : null
            }
        </div>
        <div class="quarter-status">
            {
                hasInsufficientData ? (
                    <div>
                        <div class="status-summary unknown">N/A</div>
                        <div class="status-label">Insufficient Data</div>
                    </div>
                ) : (
                    <div>
                        <div class="status-summary">
                            {passCount} Pass / {violationCount} Violation{violationCount !== 1 ? 's' : ''}
                        </div>
                        {violatedServices.length > 0 && (
                            <div class="violated-services">
                                {violatedServices.join(", ")}
                            </div>
                        )}
                    </div>
                )
            }
        </div>
        <div class="quarter-stats">
            <div>
                <strong>{totalIncidents}</strong> incidents
            </div>
            <div>
                <span class={`status-indicator status-${statusColor}`}></span>
                {
                    hasInsufficientData
                        ? "Unknown"
                        : violationCount === 0
                          ? "All services met SLA"
                          : `${worstComponent.serviceCredit}% service credit`
                }
            </div>
        </div>
    </Card>
</a>

<style>
    .quarter-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .quarter-card {
        transition:
            transform 0.2s,
            border-color 0.2s;
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .quarter-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background-color: var(--color-success);
        opacity: 0.5;
    }

    .quarter-card.status-orange::before {
        background-color: var(--color-warning);
    }

    .quarter-card.status-red::before {
        background-color: var(--color-danger);
    }

    .quarter-card.status-gray::before {
        background-color: var(--color-text-secondary);
    }

    .quarter-card:hover {
        transform: translateY(-2px);
        border-color: var(--color-text-secondary);
    }

    .quarter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .quarter-header h3 {
        font-size: 1.25rem;
        margin: 0;
    }

    .quarter-status {
        margin-bottom: 1rem;
    }

    .status-summary {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-text);
        margin-bottom: 0.5rem;
    }

    .status-green .status-summary {
        color: var(--color-success);
    }

    .status-orange .status-summary,
    .status-red .status-summary {
        color: var(--color-text);
    }

    .status-gray .status-summary {
        color: var(--color-text-secondary);
    }

    .status-summary.unknown {
        color: var(--color-text-secondary);
        font-size: 1.5rem;
    }

    .status-label {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }

    .violated-services {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
        font-weight: 500;
        line-height: 1.4;
    }

    .status-red .violated-services {
        color: var(--color-danger);
    }

    .status-orange .violated-services {
        color: var(--color-warning);
    }

    .quarter-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }

    .quarter-stats strong {
        color: var(--color-text);
    }

    .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 0.25rem;
        background-color: var(--color-success);
    }

    .status-indicator.status-orange {
        background-color: var(--color-warning);
    }

    .status-indicator.status-red {
        background-color: var(--color-danger);
    }

    .status-indicator.status-gray {
        background-color: var(--color-text-secondary);
    }
</style>
