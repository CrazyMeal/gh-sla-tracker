---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import {
  parseQuarterLabel,
  getQuarterInfo,
  formatDate,
  formatDateTime,
  formatDuration,
  getDurationMinutes,
  getQuarterTotalMinutes,
} from "../lib/date-utils";
import {
  calculateQuarterData,
  getIncidentsWithDurations,
  SERVICE_FEATURES,
  ACTIONS_SERVICES,
  PACKAGES_SERVICES,
} from "../lib/sla-calculator";
import StatsCard from "../components/dashboard/StatsCard.astro";
import SlaTable from "../components/sla/SlaTable.astro";
import IncidentCard from "../components/incidents/IncidentCard.astro";
import Badge from "../components/ui/Badge.astro";

// Get all static paths for quarters
export async function getStaticPaths() {
  const currentYear = new Date().getFullYear();
  const years = [currentYear - 1, currentYear, currentYear + 1]; // Last year, current, next
  const quarters: (1 | 2 | 3 | 4)[] = [1, 2, 3, 4];

  return years.flatMap((year) =>
    quarters.map((q) => ({
      params: { quarter: `${year}-Q${q}` },
    })),
  );
}

// Parse the quarter from URL
const { quarter: quarterLabel } = Astro.params;
const parsed = parseQuarterLabel(quarterLabel);

if (!parsed) {
  return Astro.redirect("/404");
}

const { year, quarter } = parsed;
const quarterInfo = getQuarterInfo(year, quarter);

// Fetch all incidents
const allIncidents = await getCollection("incidents");

// Calculate all quarter data using centralized function
const quarterData = calculateQuarterData(allIncidents, year, quarter);

// Destructure for easier access in template
const {
  slaResults,
  totalDowntime,
  totalIncidents,
  trackedIncidents,
  hasViolation,
  hasInsufficientData,
  worstComponent,
  quarterIncidents,
} = quarterData;

// Separate SLA results by service category
const serviceFeaturesResults = slaResults.filter(r =>
  SERVICE_FEATURES.some(s => s === r.componentName)
);
const actionsResults = slaResults.filter(r =>
  ACTIONS_SERVICES.some(s => s === r.componentName)
);
const packagesResults = slaResults.filter(r =>
  PACKAGES_SERVICES.some(s => s === r.componentName)
);

// Get incidents with durations for display
const incidentsWithDurations = getIncidentsWithDurations(quarterIncidents).sort(
  (a, b) =>
    new Date(b.data.created_at).getTime() -
    new Date(a.data.created_at).getTime(),
);

// Calculate quarter total minutes
const totalMinutes = getQuarterTotalMinutes(year, quarter);
---

<Layout
  title={`${quarterLabel} - GitHub SLA Tracker`}
  description={`SLA compliance report for GitHub services in ${quarterLabel}`}
>
  <div class="container">
    <nav class="breadcrumb">
      <a href={import.meta.env.BASE_URL}>Dashboard</a>
      <span class="separator">‚Ä∫</span>
      <span>{quarterLabel}</span>
    </nav>

    <section class="quarter-header">
      <div class="header-content">
        <h2>{quarterLabel}</h2>
        <p class="quarter-period">
          {formatDate(quarterInfo.startDate)} - {
            formatDate(quarterInfo.endDate)
          }
        </p>
      </div>
      <div class="header-status">
        {
          hasInsufficientData ? (
            <Badge variant="secondary">Unknown</Badge>
          ) : hasViolation ? (
            <Badge variant="danger">SLA Violation</Badge>
          ) : (
            <Badge variant="success">SLA Pass</Badge>
          )
        }
      </div>
    </section>

    {
      hasInsufficientData && (
        <div class="insufficient-data-notice card">
          <h3>‚ö†Ô∏è Insufficient Data</h3>
          <p>
            This quarter is before our incident tracking window. SLA compliance
            cannot be accurately calculated.
          </p>
          <p>
            The data shown below represents only the incidents we have recorded.
            It does not reflect the complete picture for this quarter.
          </p>
        </div>
      )
    }

    <section class="summary-cards grid">
      <StatsCard
        label="SLA Status"
        value={hasInsufficientData
          ? "Unknown"
          : hasViolation
            ? "Violation"
            : "All Pass"}
        subtext={hasInsufficientData
          ? "Insufficient Data"
          : hasViolation
            ? `${worstComponent.serviceCredit}% service credit`
            : "All services met 99.9% uptime"}
        valueClass={hasInsufficientData
          ? "uptime-gray"
          : hasViolation
            ? "uptime-red"
            : "uptime-green"}
      />

      <StatsCard
        label="Total Downtime"
        value={formatDuration(totalDowntime)}
        subtext="Weighted by impact"
      />

      <StatsCard
        label="Total Incidents"
        value={totalIncidents}
        subtext={`In this quarter (${trackedIncidents} tracked)`}
      />

      <StatsCard
        label="Worst Component"
        value={worstComponent.componentName}
        subtext={`${worstComponent.uptimePercentage.toFixed(3)}% uptime`}
        valueClass="text-sm"
      />
    </section>

    <!-- Service Features - Time-based SLA -->
    <section class="component-sla">
      <h2>Service Features</h2>
      <p class="section-subtitle">
        Time-based uptime calculation for the {totalMinutes.toLocaleString()} minutes in this quarter
      </p>
      <div class="methodology-note">
        <strong>Calculation Method:</strong> (Total minutes - Downtime) / Total minutes √ó 100
        <br />
        <strong>Downtime Definition:</strong> Minutes with &gt;5% error rate (approximated from incident data)
      </div>

      <SlaTable results={serviceFeaturesResults} />
    </section>

    <!-- Actions - Execution-based SLA -->
    <section class="component-sla">
      <h2>Actions</h2>
      <p class="section-subtitle">
        Execution-based calculation (workflow success rate)
      </p>
      <div class="methodology-note">
        <strong>Official Calculation Method:</strong> (Total executions - Failed executions) / Total executions √ó 100
      </div>
      <div class="data-accuracy-warning">
        <strong>‚ö†Ô∏è Data Accuracy Limitation:</strong> The GitHub Status API does not provide execution counts or failure rates.
        The uptime percentages shown below are <em>approximations</em> based on incident duration and impact,
        not the actual workflow success rate used in GitHub's official SLA calculations.
      </div>

      <SlaTable results={actionsResults} />
    </section>

    <!-- Packages - Hybrid SLA -->
    <section class="component-sla">
      <h2>Packages</h2>
      <p class="section-subtitle">
        Hybrid calculation with two separate metrics
      </p>
      <div class="methodology-note">
        <strong>Official Calculation Methods:</strong>
        <br />
        1. <strong>Package Transfers:</strong> (Total transfers - Failed transfers) / Total transfers √ó 100
        <br />
        2. <strong>Package Storage:</strong> (Total minutes - Minutes with &gt;5% error rate) / Total minutes √ó 100
      </div>
      <div class="data-accuracy-warning">
        <strong>‚ö†Ô∏è Data Accuracy Limitation:</strong> The GitHub Status API does not provide transfer counts or storage error rates.
        The uptime percentage shown below is an <em>approximation</em> based on incident duration and impact,
        not the actual metrics used in GitHub's official SLA calculations.
      </div>

      <SlaTable results={packagesResults} />
    </section>

    <section class="incidents-section">
      <h2>Incidents in {quarterLabel}</h2>
      <p class="section-subtitle">
        {totalIncidents} incident{totalIncidents !== 1 ? "s" : ""} occurred during
        this quarter
      </p>

      <div
        id="component-filter-banner"
        class="filter-banner"
        style="display: none;"
      >
        <div class="filter-content">
          <span class="filter-icon">üîç</span>
          <span class="filter-text"
            >Showing <strong id="filter-count">0</strong> incident(s) for: <strong
              id="filter-component"></strong></span
          >
          <button
            id="clear-filter"
            class="filter-clear"
            aria-label="Clear filter">‚úï</button
          >
        </div>
      </div>

      {
        incidentsWithDurations.length === 0 ? (
          <div class="card empty-state">
            <p>No incidents recorded for this quarter.</p>
          </div>
        ) : (
          <div class="incidents-list">
            {incidentsWithDurations.map((incident) => (
              <IncidentCard incident={incident} />
            ))}
          </div>
        )
      }
    </section>
  </div>
</Layout>

<style>
  .breadcrumb {
    margin-bottom: 1.5rem;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }

  .breadcrumb a {
    color: var(--color-link);
    text-decoration: none;
  }

  .breadcrumb a:hover {
    text-decoration: underline;
  }

  .breadcrumb .separator {
    margin: 0 0.5rem;
  }

  .quarter-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 2rem;
  }

  .header-content h2 {
    font-size: 2.5rem;
    margin-bottom: 0.25rem;
  }

  .quarter-period {
    color: var(--color-text-secondary);
    font-size: 1.1rem;
  }

  .summary-cards {
    margin-bottom: 3rem;
  }

  .summary-cards h3 {
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-secondary);
    margin-bottom: 0.5rem;
  }

  .uptime-green {
    color: var(--color-success);
  }

  .uptime-orange {
    color: var(--color-warning);
  }

  .uptime-red {
    color: var(--color-danger);
  }

  .uptime-gray {
    color: var(--color-text-secondary);
  }

  .insufficient-data-notice {
    background-color: rgba(210, 153, 34, 0.1);
    border-left: 4px solid var(--color-warning);
    margin-bottom: 2rem;
  }

  .insufficient-data-notice h3 {
    color: var(--color-warning);
    margin-bottom: 1rem;
  }

  .insufficient-data-notice p {
    margin-bottom: 0.75rem;
    line-height: 1.6;
  }

  .insufficient-data-notice p:last-child {
    margin-bottom: 0;
  }

  .section-subtitle {
    color: var(--color-text-secondary);
    margin-bottom: 1.5rem;
  }

  .methodology-note {
    background-color: var(--color-bg-secondary);
    border-left: 3px solid var(--color-link);
    padding: 1rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    line-height: 1.6;
    border-radius: 4px;
  }

  .methodology-note strong {
    color: var(--color-text);
  }

  .data-accuracy-warning {
    background-color: rgba(255, 159, 67, 0.1);
    border-left: 3px solid var(--color-warning);
    padding: 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
    line-height: 1.6;
    border-radius: 4px;
  }

  .data-accuracy-warning strong {
    color: var(--color-warning);
  }

  .data-accuracy-warning em {
    font-style: italic;
    color: var(--color-text);
  }

  .component-sla {
    margin-bottom: 3rem;
  }

  .component-sla h2 {
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
  }

  .incidents-section {
    margin-bottom: 3rem;
  }

  .incidents-section h2 {
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-secondary);
  }

  .incidents-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* Component row interactivity for filtering */
  .component-row {
    cursor: pointer;
    transition:
      background-color 0.2s,
      border-color 0.2s;
  }

  .component-row:hover {
    background-color: var(--color-bg-tertiary);
  }

  .component-row:focus-visible {
    outline: 2px solid var(--color-link);
    outline-offset: -2px;
  }

  .component-row.selected {
    background-color: rgba(79, 140, 201, 0.1);
    border-left: 4px solid var(--color-link);
  }

  .component-row.selected td:first-child {
    padding-left: calc(1rem - 4px);
  }

  /* Filter banner */
  .filter-banner {
    margin-bottom: 1.5rem;
    padding: 1rem 1.5rem;
    background-color: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-left: 4px solid var(--color-link);
    border-radius: 6px;
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .filter-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .filter-icon {
    font-size: 1.25rem;
  }

  .filter-text {
    flex: 1;
    font-size: 0.95rem;
    color: var(--color-text);
  }

  .filter-text strong {
    color: var(--color-link);
  }

  .filter-clear {
    background: none;
    border: none;
    color: var(--color-text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition:
      background-color 0.2s,
      color 0.2s;
  }

  .filter-clear:hover {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--color-text);
  }

  .filter-clear:focus {
    outline: 2px solid var(--color-link);
    outline-offset: 2px;
  }

  /* Smooth filtering transitions */
  .incident-card {
    transition:
      opacity 0.3s ease-out,
      transform 0.3s ease-out;
  }

  .incident-card[style*="display: none"] {
    opacity: 0;
    transform: scale(0.98);
  }
</style>

<script>
  import { ComponentFilter } from "../scripts/component-filter";

  // Initialize on page load (handles both initial load and View Transitions)
  document.addEventListener("astro:page-load", () => {
    // Check if we're on the quarter page before initializing
    if (document.querySelector(".component-row")) {
      new ComponentFilter();
    }
  });
</script>
