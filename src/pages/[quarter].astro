---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import {
  parseQuarterLabel,
  getQuarterInfo,
  formatDate,
  formatDateTime,
  formatDuration,
  getDurationMinutes,
  getQuarterTotalMinutes,
} from "../lib/date-utils";
import {
  calculateQuarterData,
  getSLAStatusColor,
  getSLAStatusLabel,
  getIncidentsWithDurations,
} from "../lib/sla-calculator";

// Get all static paths for quarters
export async function getStaticPaths() {
  const currentYear = new Date().getFullYear();
  const years = [currentYear - 1, currentYear, currentYear + 1]; // Last year, current, next
  const quarters: (1 | 2 | 3 | 4)[] = [1, 2, 3, 4];

  return years.flatMap((year) =>
    quarters.map((q) => ({
      params: { quarter: `${year}-Q${q}` },
    })),
  );
}

// Parse the quarter from URL
const { quarter: quarterLabel } = Astro.params;
const parsed = parseQuarterLabel(quarterLabel);

if (!parsed) {
  return Astro.redirect("/404");
}

const { year, quarter } = parsed;
const quarterInfo = getQuarterInfo(year, quarter);

// Fetch all incidents
const allIncidents = await getCollection("incidents");

// Calculate all quarter data using centralized function
const quarterData = calculateQuarterData(allIncidents, year, quarter);

// Destructure for easier access in template
const {
  slaResults,
  avgUptime,
  totalDowntime,
  totalIncidents,
  trackedIncidents,
  hasViolation,
  hasInsufficientData,
  worstComponent,
  quarterIncidents,
} = quarterData;

// Get incidents with durations for display
const incidentsWithDurations = getIncidentsWithDurations(quarterIncidents).sort(
  (a, b) =>
    new Date(b.data.created_at).getTime() -
    new Date(a.data.created_at).getTime(),
);

// Calculate quarter total minutes
const totalMinutes = getQuarterTotalMinutes(year, quarter);
---

<Layout
  title={`${quarterLabel} - GitHub SLA Tracker`}
  description={`SLA compliance report for GitHub services in ${quarterLabel}`}
>
  <div class="container">
    <nav class="breadcrumb">
      <a href={import.meta.env.BASE_URL}>Dashboard</a>
      <span class="separator">‚Ä∫</span>
      <span>{quarterLabel}</span>
    </nav>

    <section class="quarter-header">
      <div class="header-content">
        <h2>{quarterLabel}</h2>
        <p class="quarter-period">
          {formatDate(quarterInfo.startDate)} - {
            formatDate(quarterInfo.endDate)
          }
        </p>
      </div>
      <div class="header-status">
        {
          hasInsufficientData ? (
            <span class="badge badge-secondary">Unknown</span>
          ) : hasViolation ? (
            <span class="badge badge-danger">SLA Violation</span>
          ) : (
            <span class="badge badge-success">SLA Pass</span>
          )
        }
      </div>
    </section>

    {
      hasInsufficientData && (
        <div class="insufficient-data-notice card">
          <h3>‚ö†Ô∏è Insufficient Data</h3>
          <p>
            This quarter is before our incident tracking window. SLA compliance
            cannot be accurately calculated.
          </p>
          <p>
            The data shown below represents only the incidents we have recorded.
            It does not reflect the complete picture for this quarter.
          </p>
        </div>
      )
    }

    <section class="summary-cards grid">
      <div class="card">
        <h3>Average Uptime</h3>
        <div
          class={`stat-value uptime-${getSLAStatusColor(avgUptime, hasInsufficientData)}`}
        >
          {hasInsufficientData ? "N/A" : `${avgUptime.toFixed(3)}%`}
        </div>
        <div class="stat-label">
          {getSLAStatusLabel(avgUptime, hasInsufficientData)}
        </div>
      </div>

      <div class="card">
        <h3>Total Downtime</h3>
        <div class="stat-value">{formatDuration(totalDowntime)}</div>
        <div class="stat-label">Weighted by impact</div>
      </div>

      <div class="card">
        <h3>Total Incidents</h3>
        <div class="stat-value">{totalIncidents}</div>
        <div class="stat-label">
          In this quarter ({trackedIncidents} tracked)
        </div>
      </div>

      <div class="card">
        <h3>Worst Component</h3>
        <div class="stat-value text-sm">{worstComponent.componentName}</div>
        <div class="stat-label">
          {worstComponent.uptimePercentage.toFixed(3)}% uptime
        </div>
      </div>
    </section>

    <section class="component-sla">
      <h2>Component SLA Breakdown</h2>
      <p class="section-subtitle">
        Per-component uptime for the {totalMinutes.toLocaleString()} minutes in this
        quarter
      </p>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Component</th>
              <th>Uptime %</th>
              <th>Downtime</th>
              <th>Incidents</th>
              <th>Status</th>
              <th>Service Credit</th>
            </tr>
          </thead>
          <tbody>
            {
              slaResults.map((result) => {
                const statusColor = getSLAStatusColor(result.uptimePercentage);
                const badgeClass = result.slaViolation
                  ? "badge-danger"
                  : "badge-success";

                return (
                  <tr
                    class="component-row"
                    data-component={result.componentName}
                    data-incident-count={result.incidentCount}
                    role="button"
                    tabindex="0"
                  >
                    <td>
                      <strong>{result.componentName}</strong>
                    </td>
                    <td>
                      <span class={`uptime-value uptime-${statusColor}`}>
                        {result.uptimePercentage.toFixed(4)}%
                      </span>
                    </td>
                    <td>{formatDuration(result.totalDowntimeMinutes)}</td>
                    <td>{result.incidentCount}</td>
                    <td>
                      <span class={`badge ${badgeClass}`}>
                        {result.slaViolation ? "Violation" : "Pass"}
                      </span>
                    </td>
                    <td>
                      {result.serviceCredit > 0 ? (
                        <span class="service-credit">
                          {result.serviceCredit}%
                        </span>
                      ) : (
                        <span class="text-secondary">None</span>
                      )}
                    </td>
                  </tr>
                );
              })
            }
          </tbody>
        </table>
      </div>
    </section>

    <section class="incidents-section">
      <h2>Incidents in {quarterLabel}</h2>
      <p class="section-subtitle">
        {totalIncidents} incident{totalIncidents !== 1 ? "s" : ""} occurred during
        this quarter
      </p>

      <div
        id="component-filter-banner"
        class="filter-banner"
        style="display: none;"
      >
        <div class="filter-content">
          <span class="filter-icon">üîç</span>
          <span class="filter-text"
            >Showing <strong id="filter-count">0</strong> incident(s) for: <strong
              id="filter-component"></strong></span
          >
          <button
            id="clear-filter"
            class="filter-clear"
            aria-label="Clear filter">‚úï</button
          >
        </div>
      </div>

      {
        incidentsWithDurations.length === 0 ? (
          <div class="card empty-state">
            <p>No incidents recorded for this quarter.</p>
          </div>
        ) : (
          <div class="incidents-list">
            {incidentsWithDurations.map((incident) => {
              const impactClass =
                incident.data.impact === "critical"
                  ? "badge-danger"
                  : incident.data.impact === "major"
                    ? "badge-warning"
                    : incident.data.impact === "minor"
                      ? "badge-info"
                      : "badge-secondary";

              const statusClass =
                incident.data.status === "resolved"
                  ? "badge-success"
                  : incident.data.status === "monitoring"
                    ? "badge-info"
                    : "badge-warning";

              // Build GitHub Status incident URL (correct format)
              const incidentUrl = `https://www.githubstatus.com/incidents/${incident.data.id}`;

              return (
                <div
                  class="card incident-card"
                  data-components={
                    incident.data.components?.map((c) => c.name).join("|") || ""
                  }
                >
                  <div class="incident-header">
                    <h4>
                      <a
                        href={incidentUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="incident-title-link"
                      >
                        {incident.data.name}
                      </a>
                    </h4>
                    <div class="incident-badges">
                      <span class={`badge ${impactClass}`}>
                        {incident.data.impact}
                      </span>
                      <span class={`badge ${statusClass}`}>
                        {incident.data.status}
                      </span>
                    </div>
                  </div>

                  <div class="incident-meta">
                    <div class="meta-item">
                      <span class="meta-label">Created:</span>
                      <time datetime={incident.data.created_at}>
                        {formatDateTime(incident.data.created_at)}
                      </time>
                    </div>
                    {incident.data.resolved_at && (
                      <div class="meta-item">
                        <span class="meta-label">Resolved:</span>
                        <time datetime={incident.data.resolved_at}>
                          {formatDateTime(incident.data.resolved_at)}
                        </time>
                      </div>
                    )}
                    <div class="meta-item">
                      <span class="meta-label">Duration:</span>
                      <span>{formatDuration(incident.durationMinutes)}</span>
                    </div>
                    <div class="meta-item">
                      <span class="meta-label">Weighted Downtime:</span>
                      <span>{formatDuration(incident.weightedDowntime)}</span>
                    </div>
                  </div>

                  {incident.data.components &&
                    incident.data.components.length > 0 && (
                      <div class="incident-components">
                        <span class="meta-label">Affected Components:</span>
                        {incident.data.components.map((comp) => (
                          <span class="component-tag">{comp.name}</span>
                        ))}
                      </div>
                    )}

                  {incident.data.incident_updates.length > 0 && (
                    <details class="incident-updates">
                      {/* prettier-ignore */}
                      <summary>{incident.data.incident_updates.length} update{incident.data.incident_updates.length !== 1 ? "s" : ""}</summary>
                      <div class="updates-list">
                        {incident.data.incident_updates.map((update) => (
                          <div class="update-item">
                            <div class="update-header">
                              <span class="update-status">{update.status}</span>
                              <time datetime={update.created_at}>
                                {formatDateTime(update.created_at)}
                              </time>
                            </div>
                            <p class="update-body">{update.body}</p>
                          </div>
                        ))}
                      </div>
                    </details>
                  )}
                </div>
              );
            })}
          </div>
        )
      }
    </section>
  </div>
</Layout>

<style>
  .breadcrumb {
    margin-bottom: 1.5rem;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }

  .breadcrumb a {
    color: var(--color-link);
    text-decoration: none;
  }

  .breadcrumb a:hover {
    text-decoration: underline;
  }

  .breadcrumb .separator {
    margin: 0 0.5rem;
  }

  .quarter-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 2rem;
  }

  .header-content h2 {
    font-size: 2.5rem;
    margin-bottom: 0.25rem;
  }

  .quarter-period {
    color: var(--color-text-secondary);
    font-size: 1.1rem;
  }

  .summary-cards {
    margin-bottom: 3rem;
  }

  .summary-cards h3 {
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-secondary);
    margin-bottom: 0.5rem;
  }

  .stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-link);
    margin-bottom: 0.25rem;
  }

  .stat-value.text-sm {
    font-size: 1.5rem;
  }

  .uptime-green {
    color: var(--color-success);
  }

  .uptime-orange {
    color: var(--color-warning);
  }

  .uptime-red {
    color: var(--color-danger);
  }

  .uptime-gray {
    color: var(--color-text-secondary);
  }

  .insufficient-data-notice {
    background-color: rgba(210, 153, 34, 0.1);
    border-left: 4px solid var(--color-warning);
    margin-bottom: 2rem;
  }

  .insufficient-data-notice h3 {
    color: var(--color-warning);
    margin-bottom: 1rem;
  }

  .insufficient-data-notice p {
    margin-bottom: 0.75rem;
    line-height: 1.6;
  }

  .insufficient-data-notice p:last-child {
    margin-bottom: 0;
  }

  .stat-label {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  .section-subtitle {
    color: var(--color-text-secondary);
    margin-bottom: 1.5rem;
  }

  .component-sla {
    margin-bottom: 3rem;
  }

  .component-sla h2 {
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  .uptime-value {
    font-weight: 600;
    font-family: var(--font-mono);
  }

  .service-credit {
    font-weight: 600;
    color: var(--color-warning);
  }

  .text-secondary {
    color: var(--color-text-secondary);
  }

  .incidents-section {
    margin-bottom: 3rem;
  }

  .incidents-section h2 {
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-secondary);
  }

  .incidents-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .incident-card {
    transition: border-color 0.2s;
  }

  .incident-card:hover {
    border-color: var(--color-text-secondary);
  }

  .incident-title-link {
    color: var(--color-link);
    text-decoration: none;
    transition: color 0.2s;
  }

  .incident-title-link:hover {
    color: var(--color-link-hover);
    text-decoration: underline;
  }

  .incident-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .incident-header h4 {
    margin: 0;
    font-size: 1.1rem;
    flex: 1;
  }

  .incident-badges {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .incident-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background-color: var(--color-bg-tertiary);
    border-radius: 4px;
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .meta-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-secondary);
    font-weight: 600;
  }

  .incident-components {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 1rem;
  }

  .component-tag {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background-color: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  .incident-updates {
    margin-top: 1rem;
    border-top: 1px solid var(--color-border);
    padding-top: 1rem;
  }

  .incident-updates summary {
    cursor: pointer;
    font-weight: 600;
    color: var(--color-link);
    user-select: none;
  }

  .incident-updates summary:hover {
    color: var(--color-link-hover);
  }

  .updates-list {
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .update-item {
    padding: 1rem;
    background-color: var(--color-bg-tertiary);
    border-radius: 4px;
  }

  .update-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .update-status {
    font-weight: 600;
    text-transform: capitalize;
    color: var(--color-link);
  }

  .update-header time {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  .update-body {
    margin: 0;
    line-height: 1.6;
  }

  /* Component row interactivity for filtering */
  .component-row {
    cursor: pointer;
    transition:
      background-color 0.2s,
      border-color 0.2s;
  }

  .component-row:hover {
    background-color: var(--color-bg-tertiary);
  }

  .component-row:focus-visible {
    outline: 2px solid var(--color-link);
    outline-offset: -2px;
  }

  .component-row.selected {
    background-color: rgba(79, 140, 201, 0.1);
    border-left: 4px solid var(--color-link);
  }

  .component-row.selected td:first-child {
    padding-left: calc(1rem - 4px);
  }

  /* Filter banner */
  .filter-banner {
    margin-bottom: 1.5rem;
    padding: 1rem 1.5rem;
    background-color: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-left: 4px solid var(--color-link);
    border-radius: 6px;
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .filter-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .filter-icon {
    font-size: 1.25rem;
  }

  .filter-text {
    flex: 1;
    font-size: 0.95rem;
    color: var(--color-text);
  }

  .filter-text strong {
    color: var(--color-link);
  }

  .filter-clear {
    background: none;
    border: none;
    color: var(--color-text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition:
      background-color 0.2s,
      color 0.2s;
  }

  .filter-clear:hover {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--color-text);
  }

  .filter-clear:focus {
    outline: 2px solid var(--color-link);
    outline-offset: 2px;
  }

  /* Smooth filtering transitions */
  .incident-card {
    transition:
      opacity 0.3s ease-out,
      transform 0.3s ease-out;
  }

  .incident-card[style*="display: none"] {
    opacity: 0;
    transform: scale(0.98);
  }
</style>

<script is:inline>
  class ComponentFilter {
    constructor() {
      this.activeComponent = null;
      this.componentRows = document.querySelectorAll(".component-row");
      this.incidentCards = document.querySelectorAll(".incident-card");
      this.filterBanner = document.getElementById("component-filter-banner");
      this.filterCountElement = document.getElementById("filter-count");
      this.filterComponentElement = document.getElementById("filter-component");
      this.clearButton = document.getElementById("clear-filter");

      this.init();
    }

    init() {
      // Add click handlers to component rows
      this.componentRows.forEach((row) => {
        row.addEventListener("click", () => this.toggleFilter(row));
        row.addEventListener("keypress", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            this.toggleFilter(row);
          }
        });
      });

      // Add click handler to clear button
      this.clearButton?.addEventListener("click", () => this.clearFilter());
    }

    toggleFilter(row) {
      const componentName = row.dataset.component;

      if (this.activeComponent === componentName) {
        // Clicking same component - clear filter
        this.clearFilter();
      } else {
        // Apply new filter
        this.applyFilter(componentName, row);
      }
    }

    applyFilter(componentName, row) {
      this.activeComponent = componentName;

      // Update row selection state
      this.componentRows.forEach((r) => r.classList.remove("selected"));
      row.classList.add("selected");

      // Filter incidents using fuzzy matching
      let visibleCount = 0;
      this.incidentCards.forEach((card) => {
        const components = card.dataset.components;
        const matches = this.componentMatches(components, componentName);

        if (matches) {
          card.style.display = "";
          visibleCount++;
        } else {
          card.style.display = "none";
        }
      });

      // Update filter banner
      this.filterCountElement.textContent = visibleCount;
      this.filterComponentElement.textContent = componentName;
      this.filterBanner.style.display = "block";

      // Scroll to incidents section smoothly
      this.filterBanner.scrollIntoView({
        behavior: "smooth",
        block: "nearest",
      });
    }

    componentMatches(componentsString, targetComponent) {
      if (!componentsString) return false;

      const components = componentsString.split("|");
      return components.some((component) => {
        // Normalize and use word boundary matching (mirrors backend logic)
        const normalized = component.trim().replace(/^and\s+/i, "");
        const pattern = new RegExp(
          `\\b${this.escapeRegex(targetComponent)}\\b`,
          "i",
        );
        return pattern.test(normalized);
      });
    }

    escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    clearFilter() {
      this.activeComponent = null;

      // Clear row selection
      this.componentRows.forEach((r) => r.classList.remove("selected"));

      // Show all incidents
      this.incidentCards.forEach((card) => {
        card.style.display = "";
      });

      // Hide filter banner
      this.filterBanner.style.display = "none";
    }
  }

  // Initialize on page load (handles both initial load and View Transitions)
  document.addEventListener("astro:page-load", () => {
    // Check if we're on the quarter page before initializing
    if (document.querySelector(".component-row")) {
      new ComponentFilter();
    }
  });
</script>
