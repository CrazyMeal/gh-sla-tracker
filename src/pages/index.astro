---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { getRecentQuarters, getQuarterLabel, formatDate } from '../lib/date-utils';
import { calculateQuarterlySLA, GITHUB_SLA_COMPONENTS, getSLAStatusColor, getOldestIncidentDate } from '../lib/sla-calculator';

// Fetch all incidents from content collection
const allIncidents = await getCollection('incidents');

// Get oldest incident date to detect unknown quarters
const oldestIncidentDate = getOldestIncidentDate(allIncidents);

// Get recent quarters (last 8 quarters = 2 years)
const recentQuarters = getRecentQuarters(8);

// Calculate SLA for each quarter
const quarterlyData = recentQuarters.map(quarter => {
  const slaResults = calculateQuarterlySLA(
    allIncidents,
    quarter.year,
    quarter.quarter,
    [...GITHUB_SLA_COMPONENTS],
    oldestIncidentDate
  );

  // Calculate overall average
  const avgUptime = slaResults.reduce((sum, r) => sum + r.uptimePercentage, 0) / slaResults.length;
  const totalIncidents = slaResults.reduce((sum, r) => sum + r.incidentCount, 0);
  const hasViolation = slaResults.some(r => r.slaViolation);
  const hasInsufficientData = slaResults.some(r => r.hasInsufficientData);

  return {
    quarter,
    slaResults,
    avgUptime,
    totalIncidents,
    hasViolation,
    hasInsufficientData,
  };
});

// Get statistics
const totalIncidents = allIncidents.length;
const resolvedIncidents = allIncidents.filter(i => i.data.status === 'resolved').length;
const activeIncidents = allIncidents.filter(i => i.data.status !== 'resolved').length;

// Get most recent incidents
const recentIncidents = [...allIncidents]
  .sort((a, b) => new Date(b.data.created_at).getTime() - new Date(a.data.created_at).getTime())
  .slice(0, 5);

// Count incidents by impact
const impactCounts = allIncidents.reduce((acc, incident) => {
  acc[incident.data.impact] = (acc[incident.data.impact] || 0) + 1;
  return acc;
}, {} as Record<string, number>);
---

<Layout title="GitHub SLA Tracker - Dashboard">
	<div class="container">
		<section class="intro">
			<h2>SLA Compliance Dashboard</h2>
			<p>
				Track GitHub's 99.9% uptime commitment across all service features by calendar quarter.
				Data sourced from the <a href="https://www.githubstatus.com" target="_blank" rel="noopener">GitHub Status API</a>.
			</p>
			{oldestIncidentDate && (
				<div class="tracking-info">
					<strong>Tracking since:</strong> {formatDate(oldestIncidentDate)}
					<span class="separator">•</span>
					<span>Quarters before this date show "Unknown" status</span>
				</div>
			)}
		</section>

		<section class="stats-grid grid">
			<div class="card stat-card">
				<h3>Total Incidents</h3>
				<div class="stat-value">{totalIncidents}</div>
				<div class="stat-label">{resolvedIncidents} resolved</div>
			</div>

			<div class="card stat-card">
				<h3>Active Incidents</h3>
				<div class="stat-value">{activeIncidents}</div>
				<div class="stat-label">{activeIncidents === 0 ? 'All clear' : 'Currently active'}</div>
			</div>

			<div class="card stat-card">
				<h3>Major Impacts</h3>
				<div class="stat-value">{impactCounts.major || 0}</div>
				<div class="stat-label">Out of {totalIncidents} total</div>
			</div>

			<div class="card stat-card">
				<h3>Tracked Components</h3>
				<div class="stat-value">{GITHUB_SLA_COMPONENTS.length}</div>
				<div class="stat-label">Service features</div>
			</div>
		</section>

		<section class="quarters">
			<h2>Quarterly SLA Overview</h2>
			<p class="section-subtitle">
				GitHub commits to 99.9% uptime per calendar quarter. Click a quarter for detailed breakdown.
			</p>

			<div class="quarters-grid">
				{quarterlyData.map(({ quarter, avgUptime, totalIncidents, hasViolation, hasInsufficientData }) => {
					const statusColor = getSLAStatusColor(avgUptime, hasInsufficientData);
					const statusClass = `status-${statusColor}`;

					return (
						<a href={`/${quarter.label}`} class={`quarter-card card ${statusClass}`}>
							<div class="quarter-header">
								<h3>{quarter.label}</h3>
								{hasInsufficientData ? (
									<span class="badge badge-secondary">Unknown</span>
								) : hasViolation ? (
									<span class="badge badge-danger">SLA Violation</span>
								) : null}
							</div>
							<div class="quarter-uptime">
								{hasInsufficientData ? (
									<div>
										<div class="uptime-value unknown">N/A</div>
										<div class="uptime-label">Insufficient Data</div>
									</div>
								) : (
									<div>
										<div class="uptime-value">{avgUptime.toFixed(3)}%</div>
										<div class="uptime-label">Average Uptime</div>
									</div>
								)}
							</div>
							<div class="quarter-stats">
								<div>
									<strong>{totalIncidents}</strong> incidents
								</div>
								<div>
									<span class={`status-indicator status-${statusColor}`}></span>
									{hasInsufficientData
										? 'Unknown'
										: avgUptime >= 99.9
											? 'Pass'
											: `Violation (${avgUptime >= 99.0 ? '10%' : '25%'} credit)`}
								</div>
							</div>
						</a>
					);
				})}
			</div>
		</section>

		<section class="recent-incidents">
			<h2>Recent Incidents</h2>
			<div class="incidents-list">
				{recentIncidents.map(incident => {
					const impactClass = incident.data.impact === 'critical' ? 'badge-danger' :
					                   incident.data.impact === 'major' ? 'badge-warning' :
					                   incident.data.impact === 'minor' ? 'badge-info' :
					                   'badge-secondary';

					const statusClass = incident.data.status === 'resolved' ? 'badge-success' :
					                   incident.data.status === 'monitoring' ? 'badge-info' :
					                   'badge-warning';

					const date = new Date(incident.data.created_at);
					const formattedDate = date.toLocaleDateString('en-US', {
						year: 'numeric',
						month: 'short',
						day: 'numeric',
						hour: '2-digit',
						minute: '2-digit'
					});

					return (
						<div class="card incident-item">
							<div class="incident-header">
								<h4>{incident.data.name}</h4>
								<div class="incident-badges">
									<span class={`badge ${impactClass}`}>{incident.data.impact}</span>
									<span class={`badge ${statusClass}`}>{incident.data.status}</span>
								</div>
							</div>
							<div class="incident-meta">
								<time datetime={incident.data.created_at}>{formattedDate}</time>
								<span class="separator">•</span>
								<span>{incident.data.components?.length || 0} component{incident.data.components?.length !== 1 ? 's' : ''} affected</span>
							</div>
							{incident.data.components && incident.data.components.length > 0 && (
								<div class="incident-components">
									{incident.data.components.slice(0, 5).map(comp => (
										<span class="component-tag">{comp.name}</span>
									))}
									{incident.data.components.length > 5 && (
										<span class="component-tag">+{incident.data.components.length - 5} more</span>
									)}
								</div>
							)}
						</div>
					);
				})}
			</div>
		</section>
	</div>
</Layout>

<style>
	.intro {
		margin-bottom: 2rem;
	}

	.intro h2 {
		font-size: 2rem;
		margin-bottom: 0.5rem;
	}

	.intro p {
		color: var(--color-text-secondary);
		font-size: 1.1rem;
	}

	.tracking-info {
		margin-top: 1rem;
		padding: 0.75rem 1rem;
		background-color: var(--color-bg-tertiary);
		border-radius: 6px;
		font-size: 0.875rem;
		color: var(--color-text-secondary);
	}

	.tracking-info strong {
		color: var(--color-text);
	}

	.section-subtitle {
		color: var(--color-text-secondary);
		margin-bottom: 1.5rem;
	}

	.stats-grid {
		margin-bottom: 3rem;
	}

	.stat-card h3 {
		font-size: 0.875rem;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: var(--color-text-secondary);
		margin-bottom: 0.5rem;
	}

	.stat-value {
		font-size: 2.5rem;
		font-weight: 700;
		color: var(--color-link);
		margin-bottom: 0.25rem;
	}

	.stat-label {
		font-size: 0.875rem;
		color: var(--color-text-secondary);
	}

	.quarters {
		margin-bottom: 3rem;
	}

	.quarters h2 {
		font-size: 1.75rem;
		margin-bottom: 0.5rem;
	}

	.quarters-grid {
		display: grid;
		gap: 1rem;
		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
	}

	.quarter-card {
		display: block;
		text-decoration: none;
		color: inherit;
		transition: transform 0.2s, border-color 0.2s;
		position: relative;
		overflow: hidden;
	}

	.quarter-card::before {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		width: 4px;
		height: 100%;
		background-color: var(--color-success);
		opacity: 0.5;
	}

	.quarter-card.status-orange::before {
		background-color: var(--color-warning);
	}

	.quarter-card.status-red::before {
		background-color: var(--color-danger);
	}

	.quarter-card.status-gray::before {
		background-color: var(--color-text-secondary);
	}

	.quarter-card:hover {
		transform: translateY(-2px);
		border-color: var(--color-text-secondary);
	}

	.quarter-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1rem;
	}

	.quarter-header h3 {
		font-size: 1.25rem;
		margin: 0;
	}

	.quarter-uptime {
		margin-bottom: 1rem;
	}

	.uptime-value {
		font-size: 2rem;
		font-weight: 700;
		color: var(--color-link);
	}

	.status-green .uptime-value {
		color: var(--color-success);
	}

	.status-orange .uptime-value {
		color: var(--color-warning);
	}

	.status-red .uptime-value {
		color: var(--color-danger);
	}

	.status-gray .uptime-value {
		color: var(--color-text-secondary);
	}

	.uptime-value.unknown {
		color: var(--color-text-secondary);
		font-size: 1.5rem;
	}

	.uptime-label {
		font-size: 0.875rem;
		color: var(--color-text-secondary);
	}

	.quarter-stats {
		display: flex;
		justify-content: space-between;
		align-items: center;
		font-size: 0.875rem;
		color: var(--color-text-secondary);
	}

	.quarter-stats strong {
		color: var(--color-text);
	}

	.status-indicator {
		display: inline-block;
		width: 8px;
		height: 8px;
		border-radius: 50%;
		margin-right: 0.25rem;
		background-color: var(--color-success);
	}

	.status-indicator.status-orange {
		background-color: var(--color-warning);
	}

	.status-indicator.status-red {
		background-color: var(--color-danger);
	}

	.status-indicator.status-gray {
		background-color: var(--color-text-secondary);
	}

	.recent-incidents {
		margin-bottom: 3rem;
	}

	.recent-incidents h2 {
		font-size: 1.75rem;
		margin-bottom: 1.5rem;
	}

	.incidents-list {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.incident-item {
		transition: border-color 0.2s;
	}

	.incident-item:hover {
		border-color: var(--color-text-secondary);
	}

	.incident-header {
		display: flex;
		justify-content: space-between;
		align-items: start;
		gap: 1rem;
		margin-bottom: 0.75rem;
	}

	.incident-header h4 {
		margin: 0;
		font-size: 1.1rem;
		flex: 1;
	}

	.incident-badges {
		display: flex;
		gap: 0.5rem;
		flex-shrink: 0;
	}

	.incident-meta {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		color: var(--color-text-secondary);
		font-size: 0.875rem;
		margin-bottom: 0.75rem;
	}

	.separator {
		opacity: 0.5;
	}

	.incident-components {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}

	.component-tag {
		display: inline-block;
		padding: 0.25rem 0.75rem;
		background-color: var(--color-bg-tertiary);
		border: 1px solid var(--color-border);
		border-radius: 4px;
		font-size: 0.75rem;
		color: var(--color-text-secondary);
	}
</style>
