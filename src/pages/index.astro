---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { getRecentQuarters, formatDateTime } from "../lib/date-utils";
import { calculateQuarterData, getIncidentsWithDurations } from "../lib/sla-calculator";
import StatsCard from "../components/dashboard/StatsCard.astro";
import QuarterCard from "../components/dashboard/QuarterCard.astro";
import IncidentCard from "../components/incidents/IncidentCard.astro";

// Fetch all incidents from content collection
const allIncidents = await getCollection("incidents");

// Get recent quarters (last 8 quarters = 2 years)
const recentQuarters = getRecentQuarters(8);

// Calculate SLA for each quarter using centralized function
const quarterlyData = recentQuarters.map((quarter) =>
	calculateQuarterData(allIncidents, quarter.year, quarter.quarter),
);

// Get statistics
const totalIncidents = allIncidents.length;
const resolvedIncidents = allIncidents.filter(
	(i) => i.data.status === "resolved",
).length;

// Get most recent incidents with calculated durations
const recentIncidents = getIncidentsWithDurations(allIncidents)
	.sort(
		(a, b) =>
			new Date(b.data.created_at).getTime() -
			new Date(a.data.created_at).getTime(),
	)
	.slice(0, 5);

// Count incidents by impact
const impactCounts = allIncidents.reduce(
	(acc, incident) => {
		acc[incident.data.impact] = (acc[incident.data.impact] || 0) + 1;
		return acc;
	},
	{} as Record<string, number>,
);
---

<Layout title="GitHub SLA Tracker - Dashboard">
	<div class="container">
		<section class="intro">
			<h2>SLA Compliance Dashboard</h2>
			<p>
				Track GitHub's 99.9% uptime commitment for each service by calendar quarter.
				Each service is measured independently against the SLA target.
				Data sourced from the <a
					href="https://www.githubstatus.com"
					target="_blank"
					rel="noopener">GitHub Status API</a
				>.
			</p>
		</section>

		<section class="stats-grid grid">
			<StatsCard
				label="Total Incidents"
				value={totalIncidents}
				subtext={`${resolvedIncidents} resolved`}
			/>

			<StatsCard
				label="Major Impacts"
				value={impactCounts.major || 0}
				subtext={`Out of ${totalIncidents} total`}
			/>
		</section>

		<section class="quarters">
			<h2>Quarterly SLA Overview</h2>
			<div class="quarters-grid">
				{
					quarterlyData.map((data) => (
						<QuarterCard quarterData={data} />
					))
				}
			</div>
		</section>

		<section class="recent-incidents">
			<h2>Recent Incidents</h2>
			<div class="incidents-list">
				{
					recentIncidents.map((incident) => (
						<IncidentCard incident={incident} />
					))
				}
			</div>
		</section>
	</div>
</Layout>

<style>
	.intro {
		margin-bottom: 2rem;
	}

	.intro h2 {
		font-size: 2rem;
		margin-bottom: 0.5rem;
	}

	.intro p {
		color: var(--color-text-secondary);
		font-size: 1.1rem;
	}

	.stats-grid {
		margin-bottom: 3rem;
	}

	.quarters {
		margin-bottom: 3rem;
	}

	.quarters h2 {
		font-size: 1.75rem;
		margin-bottom: 0.5rem;
	}

	.quarters-grid {
		display: grid;
		gap: 1rem;
		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
	}

	.recent-incidents {
		margin-bottom: 3rem;
	}

	.recent-incidents h2 {
		font-size: 1.75rem;
		margin-bottom: 1.5rem;
	}

	.incidents-list {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
</style>
